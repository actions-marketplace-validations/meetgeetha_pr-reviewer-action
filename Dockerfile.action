FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Force rebuild - v1.0.2 (fixes missing _detect_language and _format_review_comment methods)

# Copy backend code
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY backend/ .

# Initialize RAG knowledge base
RUN python init_rag.py || echo "RAG initialization skipped"

# Copy action entrypoint
COPY action-entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
